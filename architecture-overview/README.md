# Architecture Overview

基于Axon的应用程序遵循一种基于领域驱动设计\(DDD\)原理的架构模式, 命令查询责任隔离(CQRS)和事件驱动架构 \(EDA\)。这些原则的结合使基于Axon的应用程序更加健壮并且适应性强，可以适应我们业务领域的变化而变化。

Axon既可用于大型单体应用，也可用于内部整体结构，以保持整体的适应性；而微服务则可用于系统的分布式特性，从而增加了复杂性。

以下各节描述了不同原理之间的关系以及Axon如何使用这些原理来帮助您构建更易维护，性能更高且更可靠的软件。
## 处理复杂性

Axon源于试图为不断增加的意外复杂性找到解决方案。应用领域驱动设计中的概念将在很大程度上有所帮助，即使设计最出色的模型也无法在生产中自行运行。

虽然Axon对如何与领域模型进行交互持不同观点，但它努力避免对建模自由的任何限制。
即使你的观点与Axon不同，也有足够的hooks、配置选项和触发器来改变Axon行为的某些方面。你可以在参考指南中找到这些。
### DDD & CQRS

领域驱动设计\(DDD\)描述了一种构建软件的方法，该方法非常重视模型的设计，并使用常见的语言。领域模型是软件的心脏，应该正确地捕捉和处理领域的基本复杂性。

命令查询责任隔离\(CQRS\)是一种架构模式，它描述了应用程序中处理命令\(请求更改应用程序状态\)的部分与回答查询\(请求有关应用程序状态的信息\)的部分之间的区别。

当组合DDD和CQRS时，将应用程序划分为多个组件，其中每个组件要么提供有关应用程序状态的信息，要么改变应用程序状态。每个组件都有侧重于这些职责的模型。

下图显示了基于Axon的应用程序的典型架构。

![Architecture overview of a CQRS based Axon application](../.gitbook/assets/architecture-overview.png)

在这样的架构中，UI\(或API\)可以发送命令请求更改应用程序的状态。这些命令由命令处理组件处理，组件使用模型来验证命令并决定触发\(如果有\)的副作用。

命令引起的副作用是使用事件发布的。这些事件由采取适当操作的一个或多个事件处理组件拾取。一个典型的操作是更新视图模型，它允许UI呈现应用程序的状态。其他操作可以是向外部组件发送消息，甚至通过新命令触发其他副作用。

命令模型和查询模型\(也称为视图模型或投影\)的分离允许这些模型只关注应用程序的特定方面。这使得每个单独的模型更容易理解，因此更易于长期维护。

### 业务逻辑和基础结构的分离

意外复杂性的增加通常是基础架构关注点与业务逻辑混合的抽象漏洞造成的。Axon的首要任务是将二者严格分离。在Axon的设计中，每一处都明确区分了“你想做什么”(例如，发布一个事件)和“实际如何做”(例如，事件发布实现)。

这使得Axon易于配置和适应具体情况。更重要的是，它将偶然的复杂性保持在最低限度。例如，虽然Axon让实现事件源聚合变得容易，但它绝不强制聚合为事件源。Repository接口完全抽象了这个决策。另外，决定通过命令总线发送命令的组件不负责决定如何将消息传输到处理程序。

Axon不仅通过向组件提供清晰的接口来实现这种分离，它还结合了配置API中的基础架构选择，业务逻辑组件是与应用程序的基础架构方面分开配置的。

## 显式消息

Axon坚决地利用显式消息对象的使用。这意味着基于Axon的应用程序中的每条消息通常由该应用程序中的特定Java类表示。虽然这会在编写基于Axon的应用程序时产生一些开销，但它确实有一些优点：

* 显式消息的使用使得透明地发布到远程组件更加容易；
* 显式消息的使用将重点放在消息设计上，这在应用程序的长期可维护性中被证明是重要的；
* 显式消息可以很容易地存储起来供以后处理

虽然消息传递是Axon的核心概念，但并非所有消息都是平等的。不同的意图需要不同的路由模式。例如，对于某条消息，一个人期望得到一个结果，而另一个人则天生就很容易忘记。

Axon将消息分为三类：

* **Commands**; 表示更改应用程序状态的意图。命令被路由到单个目的地，并且可以提供响应。
* **Queries**; 表达对信息的渴望。根据调度策略，查询可以同时路由到一个或多个目的地。
* **Events**; 表示已发生相关事件的通知。事件被发布到任何感兴趣的组件，并且不提供任何形式的返回值。

### 位置透明

使用显式消息的最大好处是，相互交互的组件不需要知道对方的位置。事实上，在大多数情况下，发送组件甚至对消息的实际目的地都不感兴趣。我们称之为"位置透明"。

Axon比将服务放在逻辑URL后面更具有位置透明性。在Axon中，发送消息的组件不需要为该消息指定目的地。消息的路由基于它们的原型(命令、查询或事件)和它们所携带的数据类型。Axon使用应用程序的功能自动为消息找到合适的目的地。

由位置透明组件组成的系统使该系统具有很强的适应性。例如，由单独使用命令、事件和查询进行通信的分离良好的组件构建的单体系统可以轻松地拆分为单独部署的单元，而不会对功能产生任何影响。

![Microservices Evolution through Location Transparency](../.gitbook/assets/location-transparency.png)

这使得Axon非常适合微服务环境。逻辑可以很容易地在部署的组件之间移动，而不会影响整个系统的功能方面。然后，逻辑的位置可以主要根据该系统每个单独组件的非功能性需求来决定。例如，可以将具有明显不同性能特征的组件或需要不同发布周期的组件从单体应用程序中分离出来，以减少更改对该组件的影响。

### 事件溯源

在许多系统中，事件得到更多的关注。虽然Axon清楚地认识到并非每个消息都是事件(还有命令和查询)，但事件有其特殊之处。

事件保留价值。当命令和查询触发了副作用或提供了结果时，其价值会显著降低，而事件表示已经发生的事情，有利于了解在很长一段时间内发生的事情。

事件为审计跟踪提供了非常好的粒度级别。但是，要使审计跟踪具有100％的可靠性，它不仅应作为副作用而产生，而且还必须能够确保审计跟踪正确反映了所有决策。

事件溯源是这样一个过程：事件不仅作为命令的副作用生成，而且还形成状态的源。虽然应用程序的当前状态没有显式存储在数据库中，但它隐式地存储为一系列事件，这些事件可用于演变出当前状态。收到命令后，应用程序的状态将从数据库中存储的事件动态演变，然后决定应用哪些副作用。

事件溯源要自己实现可能非常复杂。Axon提供了必要的api，使得构建命令模型非常简单，甚至更自然。Axon的测试夹具有助于确保某些准则和要求得到适当遵守。

拥有可靠的审计线索不仅对系统的可审计性有帮助，而且为建立新的视图模型、进行数据分析提供了必要的信息，为机器学习算法提供了坚实的基础。
